---
Title: "West Nile virus"
output:
  html_document:
    pagetitle: 'West Nile Virus Surveillance' 
    css: ['css/style.css', 'css/style_new.css', 'css/base.css', 'css/adjust_base_on_width.css']
    includes:
      in_header: 'www/hero-image_test.html'
      after_body: 'www/footer.html'
    toc: no
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: no

runtime: shiny_prerendered
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

getwd()

knitr::opts_chunk$set(echo      = FALSE)
knitr::opts_chunk$set(warning   = FALSE)
knitr::opts_chunk$set(message   = FALSE)
knitr::opts_chunk$set(fig.align = 'center')
library(rmarkdown)
library(magrittr)
library(scales)
library(lubridate)
library(ggplot2)
library(plotly)
library(sf)
library(dplyr)
library(shiny)
library(tidyr)
library(tibble)
library(shinyalert)
library(tidyverse)
library(janitor)
library(stringr)
library(gt)
library(here)
library(rio)
library(bcmaps)
library(tmap)
library(DT)
library(writexl)
library(readxl)

# Quinn's app

library(rlang)
library(shinyWidgets)
library(leaflet)
library(bslib)
library(shinyjs)
library(rmapshaper)
library(prettymapr)
library(bsicons)

```


<!--Change idle time -->
```{r, context = 'server', echo=FALSE, message=FALSE, warning=FALSE}

keep_alive <- shiny::reactiveTimer(
  intervalMs = 120000,
  session    = shiny::getDefaultReactiveDomain()
  )

shiny::observe(
  {
    if(req(input$isActive) %>% as.logical) keep_alive()
    }
  )

```


```{r data, cache = F, echo=FALSE, message=FALSE, warning=FALSE}

data_notes_outbreak <- 
  readLines(
    'www/data_notes_outbreak.txt'
  )

definitions_outbreak <- 
  readLines(
    'www/definitions_outbreak.txt'
)

abbreviations_outbreak <- 
  readLines(
    'www/abbreviations_outbreak.txt'
  )

disclaimer_outbreak <- 
  readLines(
    'www/disclaimer_outbreak.txt'
  )

acknowledgements_outbreak <-
  readLines(
    'www/acknowledgements_outbreak.txt'
  )

aedes <-
  readLines(
    'www/aedes.txt'
  )

anopheles <-
  readLines(
    'www/anopheles.txt'
  )

coquilletidia <-
  readLines(
    'www/coquillettidia.txt'
  )

culex <-
  readLines(
    'www/culex.txt'
  )

culiseta <-
  readLines(
    'www/culiseta.txt'
  )

####### WEST NILE VIRUS

# Epi Curve Data Load

indicators_human <- c("Cases by location of acquisition", "Cases by clinical presentation")
indicators_animal <- c("Cases by location of acquisition", "Cases by species")

animal_wnv_cases <- import("O:\\BCCDC\\Groups\\Data_Surveillance\\Vectorborne\\Shiny Dashboard Data\\Animal WNv Cases.xlsx")
human_wnv_cases <- import("O:\\BCCDC\\Groups\\Data_Surveillance\\Vectorborne\\Shiny Dashboard Data\\Human WNv Cases.xlsx")


# Define full year range (modify as needed)
full_years <- seq(min(c(human_wnv_cases$Year, animal_wnv_cases$Year), na.rm = TRUE),
                  max(c(human_wnv_cases$Year, animal_wnv_cases$Year), na.rm = TRUE), by = 1)

# Define custom colors
custom_colors <- c(
  "Travel-related" = "#FF5733",  
  "Locally acquired" = "#2980B9",  
  "Unknown" = "#808080",  
  "West Nile neurological syndrome" = "#F1C40F",  
  "West Nile non-neurological syndrome" = "#E67E22",  
  "Asymptomatic" = "green", 
  "Unspecified" = "grey",
  "Corvid" = "cyan",  
  "Horse" = "#8E44AD", 
  "Mosquito Pool" = "#2ECC71" 
)


# Location of Wnv Detections
#load data####

# data_folder = "//phsabc/root/BCCDC/Groups/Data_Surveillance/Vectorborne/Shiny Dashboard Data/"
# script_folder = "//phsabc/root/BCCDC/Groups/Data_Surveillance/Vectorborne/Shiny Dashboard Data/"

# WNV_Animal = readxl::read_xlsx(paste(data_folder, "Animal WNv Cases.xlsx",sep = ""))%>% 
#   as.data.frame()%>%
#   clean_names()

#local detections in Animals
WNV_Animal <- animal_wnv_cases %>%
  clean_names()%>%
  filter(travel != "Yes")%>%
  select(year, lha, animal_type)

#locally-acquired human cases
WNV_Human <- human_wnv_cases %>%
  clean_names()%>%
  filter(travel %in% c("No", "NO", "no"))%>%
  mutate(animal_type = "Human") %>%
  select(year, lha, animal_type)

#merge
WNV_detections = WNV_Human %>%
  bind_rows(WNV_Animal)

#basemap of LHAs####
lha <- bcmaps::health_lha(ask = FALSE, force = FALSE)%>%
        st_transform(crs = 4326) %>%
        rmapshaper::ms_simplify(keep = 0.05, keep_shapes = TRUE)


######## MOSQUITO SURVEILLANNCE

# Map and Table Data Upload

# Loading shapefiles 
# HSDA_layer <- health_hsda()

HSDA_layer <- bcmaps::health_hsda(ask = FALSE, force = FALSE)%>%
        st_transform(crs = 4326) %>%
        rmapshaper::ms_simplify(keep = 0.05, keep_shapes = TRUE)

#HA_layer <- health_ha()

HA_layer <- bcmaps::health_ha(ask = FALSE, force = FALSE)%>%
        st_transform(crs = 4326) %>%
        rmapshaper::ms_simplify(keep = 0.05, keep_shapes = TRUE)


# loading dataset
# mosquito_count_reports <- import("O:\\BCCDC\\Groups\\Data_Surveillance\\Vectorborne\\Shiny Dashboard Data\\Mosquito Count Reports.xlsx")

file_path <- "O:\\BCCDC\\Groups\\Data_Surveillance\\Vectorborne\\Shiny Dashboard Data\\Summary of Mosquito Surveillance 2003-2014.xlsx"

# Get all sheet names (M2003 - M2014)
sheet_names <- excel_sheets(file_path)

# Function to read a sheet and add the "Year" column
read_and_label <- function(sheet) {
  year <- as.numeric(gsub("M", "", sheet))  # Extract numeric year from sheet name
  import(file_path, which = sheet) %>%
    mutate(Year = year)  # Add Year column
}

# Read all sheets and combine into one dataframe
mosquito_count_reports <- bind_rows(lapply(sheet_names, read_and_label)) %>%
  rename(HSDA = `HSDA Code`,
         Coquillettidia = `Coquilletidia perturbans`) %>%
  filter(`HSDA ID` != 99) %>%
  select(- c(`HSDA ID`, `Culex unknown species`))


mosquito_count_reports1 <- mosquito_count_reports %>%
  mutate(HSDA = dplyr::case_when(
    HSDA == "CVI" ~ "Central Vancouver Island",
    HSDA == "EK" ~ "East Kootenay",
    HSDA == "FE" ~ "Fraser East",
    HSDA == "FN" ~ "Fraser North",
    HSDA == "FS" ~ "Fraser South",
    HSDA == "KB" ~ "Kootenay Boundary",
    HSDA == "NE" ~ "Northeast",
    HSDA == "NI" ~ "Northern Interior",
    HSDA == "NSCG" ~ "North Shore/Coast Garibaldi",
    HSDA == "NVI" ~ "North Vancouver Island",
    HSDA == "NW" ~ "Northwest",
    HSDA == "OK" ~ "Okanagan",
    HSDA == "RICH" ~ "Richmond",
    HSDA == "SVI" ~ "South Vancouver Island",
    HSDA == "TCS" ~ "Thompson Cariboo Shuswap",
    HSDA == "VAN" ~ "Vancouver"))


# defining input variables

current_year <- as.numeric(format(Sys.Date(), "%Y"))
# years <- seq(current_year, 2003, by = -1 )
years <- c(2024, 2014:2003)

Culex <- c("Culex pipiens",	"Culex tarsalis",	"Culex territans")
species <- c("All species", "Aedes",	"Anopheles", "Coquillettidia", Culex, "Culiseta")

HSDA_full_names <- c(
  "All HSDA's",
  "Central Vancouver Island",
  "East Kootenay",
  "Fraser East",
  "Fraser North",
  "Fraser South",
  "Kootenay Boundary",
  "Northeast",
  "Northern Interior",
  "North Shore/Coast Garibaldi",
  "North Vancouver Island",
  "Northwest",
  "Okanagan",
  "Richmond",
  "South Vancouver Island",
  "Thompson Cariboo Shuswap",
  "Vancouver"
)

# Reverse the mapping for the dropdown display
HSDA_reverse_map <- setNames(HSDA_full_names, HSDA_full_names)



```



<br>


## This report contains updated information on West Nile virus (WNV) detections in humans, corvids, and horses across the province of British Columbia (BC). Additionally included are historic findings from when mosquito trapping was conducted annually as part of routine annual WNV surveillance in BC (2003-2014). Mosquito sampling was briefly resumed in 2024 as part of a pilot program but is not routinely conducted as a part of the WNV surveillance program in BC. {.unlisted .unnumbered}


#### This page is updated as positive cases are reported. Report updated on **`r Sys.Date()`**.

<br>



```{r key-message, echo=FALSE, message=FALSE, warning=FALSE}

card(   
    tags$p(   
        "Key message on WNv",   
        style = "padding: 10px; font-size: 14px;"
       ),   
    style = "border: 1px solid #ccc; border-radius: 8px !important; box-shadow: 2px 2px 6px rgba(0,0,0,0.1) !important; width: 100%;"
    )


```


<br>

![](images/Line1.png)



<br>

<div class="section_topic1">

# West Nile Virus

#### West Nile virus (WNv) surveillance in British Columbia has been conducted through testing horses and birds that are sick or dead, and humans who have symptoms compatible with WNV. Blood and organ donations are also screened for WNV.

<br>

```{r, epi-curve, context='render', echo=FALSE, message=FALSE, warning=FALSE}

# Epi Curve UI

fluidPage(
 # titlePanel("West Nile Virus Cases"),
  id = "smallTabs",
  tabsetPanel(
    tabPanel("Human Cases",
             #br(),
             selectInput("indicator_human", "Select Indicator:", indicators_human),
             #br(),
             plotlyOutput("epi_curve_human", 
                          width  = '100%',
                          height = 500)
    ),
    
    tabPanel("Animal Detections",
             #br(),
             selectInput("indicator_animal", "Select Indicator:", indicators_animal),
             #br(),
             plotlyOutput("epi_curve_animal", 
                          width  = '100%',
                          height = 500)
    )
  )
)


```


```{r, context='server', echo=FALSE, message=FALSE, warning=FALSE}

#Epi curve server

human_title <- reactive({
    paste("Human Cases of West Nile virus in British Columbia by", 
          tolower(gsub("Cases by ", "", input$indicator_human))) 
  })
  
  animal_title <- reactive({
    paste("Animal Cases of West Nile virus in British Columbia by", 
          tolower(gsub("Cases by ", "", input$indicator_animal))) 
  })
  
  
  # **Reactive Data Filtering for Human Cases**
  human_data <- reactive({
    data <- human_wnv_cases
    
    if (input$indicator_human == "Cases by location of acquisition") {
      data <- data %>%
        mutate(Category = case_when(
          Travel == "Yes" ~ "Travel-related",
          Travel == "No" ~ "Locally acquired",
          TRUE ~ "Unknown"
        )) %>%
        group_by(Year, Category) %>%
        summarise(Cases = n(), .groups = "drop") %>%
        complete(Year = full_years, Category, fill = list(Cases = 0)) %>%  # Ensures all years exist and missing years are included with 0 cases.
        mutate(Description = paste(
          Cases, ifelse(Cases == 1, "case", "cases"), "of WNv was reported in people with",
          ifelse(Category == "Travel-related", "history of travel, outside of British Columbia", "no travel history"),
          "in", Year
        ))
      
    } else if (input$indicator_human == "Cases by clinical presentation") {
      data <- data %>%
        mutate(`Disease classification` = case_when(
          `Disease classification` == "WNNS" ~ "West Nile neurological syndrome",
          `Disease classification` == "WN non-NS" ~ "West Nile non-neurological syndrome",
          `Disease classification` == "WNAI" ~ "Asymptomatic",
          TRUE ~ "Unspecified")) %>%
        group_by(Year, Category = `Disease classification`) %>%
        summarise(Cases = n(), .groups = "drop") %>%
        complete(Year = full_years, Category, fill = list(Cases = 0)) %>% 
        mutate(Description = paste(
          Cases, ifelse(Cases == 1, "case", "cases"), "of WNv was reported with", Category, "in", Year
        ))
    }
    
    return(data)
  })
  
  # **Reactive Data Filtering for Animal Cases**
  animal_data <- reactive({
    data <- animal_wnv_cases
    
    if (input$indicator_animal == "Cases by species") {
      data <- data %>%
        group_by(Year, Category = `Animal Type`) %>%
        summarise(Cases = n(), .groups = "drop") %>%
        complete(Year = full_years, Category, fill = list(Cases = 0)) %>%  
        mutate(Description = paste(
          Cases, ifelse(Cases == 1, "case", "cases"), "of WNv in", Category, "in", Year
        ))
      
    } else if (input$indicator_animal == "Cases by location of acquisition") {
      data <- data %>%
        mutate(Category = case_when(
          Travel == "Yes" ~ "Travel-related",
          Travel == "No" ~ "Locally acquired",
          TRUE ~ "Unknown"
        )) %>%
        group_by(Year, Category) %>%
        summarise(Cases = n(), .groups = "drop") %>%
        complete(Year = full_years, Category, fill = list(Cases = 0)) %>%  
        mutate(Description = paste(
          Cases, ifelse(Cases == 1, "case", "cases"), "of WNv was reported in animals with",
          ifelse(Category == "Travel-related", "travel history", "no travel history"),
          "in", Year
        ))
    }
    
    return(data)
  })
  
  # **Render Interactive Stacked Bar Chart for Human Cases**
  output$epi_curve_human <- renderPlotly({
    req(human_data())  
    
  plot_ly(
    data = human_data(),
    x = ~Year,
    y = ~Cases,
    color = ~Category,
    text = ~Description,
    type = 'bar',
    hoverinfo = 'text',
    colors = custom_colors) %>% 
  layout(
    title = list(text = human_title(), 
                 font = list(size = 18, 
                             family = 'Arial', 
                             color = 'grey', 
                             weight = 'bold'),
                 x = 0.5 ), # Center the title
    xaxis = list(
      title = list(text = 'Year', font = list(size = 14, family = 'Arial', color = 'grey')),
      tickangle = 90,
      tickvals = seq(min(human_data()$Year, na.rm = TRUE), max(human_data()$Year, na.rm = TRUE), by = 1),
      zeroline = FALSE),
    yaxis = list(
      title = list(text = 'Cases', font = list(size = 14, family = 'Arial', color = 'grey')),
      range = c(0, 30),
      tickvals = seq(0, 30, by = 2),
      gridcolor = 'dark grey'
    ),
    barmode = 'stack',  
    plot_bgcolor = 'white',
    paper_bgcolor = 'white',
    legend = list(title = list(text = 'Category')),
    margin = list(t = 80)  # Increase top margin to avoid overlap
      ) %>% 
  config(
        displayModeBar = TRUE, 
        displaylogo = FALSE,  
        modeBarButtonsToRemove = c( 'pan2d', 'select2d', 'lasso2d')  # Remove unnecessary buttons
      ) 
  })
  
  # **Render Interactive Stacked Bar Chart for Animal Cases**
  output$epi_curve_animal <- renderPlotly({
    req(animal_data())
    
plot_ly(
  data = animal_data(),
  x = ~Year,
  y = ~Cases,
  color = ~Category,
  text = ~Description,
  type = 'bar',
  hoverinfo = 'text',
  colors = custom_colors
) %>% 
  layout(
    title = list(text = animal_title(), font = list(size = 18, family = 'Arial', color = 'grey', weight = 'bold'),
                 x = 0.5  # Center the title
                 ),
    xaxis = list(
      title = list(text = 'Year', font = list(size = 14, family = 'Arial', color = 'grey')),
      tickangle = 90,
      tickvals = seq(min(animal_data()$Year, na.rm = TRUE), max(animal_data()$Year, na.rm = TRUE), by = 1),
      zeroline = FALSE
    ),
    yaxis = list(
      title = list(text = 'Cases', font = list(size = 14, family = 'Arial', color = 'grey')),
      range = c(0, 20),
      tickvals = seq(0, 20, by = 2),
      gridcolor = 'dark grey'
    ),
    barmode = 'stack',  # Stacked bar chart
    plot_bgcolor = 'white',
    paper_bgcolor = 'white',
    legend = list(title = list(text = 'Category')),
    margin = list(t = 80)  
      ) %>% 
  config(
        displayModeBar = TRUE, 
        displaylogo = FALSE, 
        modeBarButtonsToRemove = c('zoom2d', 'pan2d', 'select2d', 'lasso2d')  # Remove unnecessary buttons
      )

  })


```


## Location of WNV Detections


```{r, wnv-detection, context='render', echo=FALSE, message=FALSE, warning=FALSE}

fluidRow(
         titlePanel("Detections of West Nile virus in British Columbia"),
      # Year slider
      column(7, 
        sliderInput("slider",
                    "Select Year(s):",
                    min = min(WNV_detections$year),
                    max = year(Sys.Date()),
                    value = c(min(WNV_detections$year), year(Sys.Date())),
                    sep = "",
                    ticks = FALSE,
                    step = 1, 
                    dragRange = FALSE)),

      # Species picker
      column(5,
             pickerInput(
        inputId = "select_species",
        label = "Select species:",
        choices = c(
          "Humans" = "Human",
          "Horses" = "Horse",
          "Corvids" = "Corvid",
          "Mosquito Pools" = "Mosquito Pool"
        ),
        selected = c("Human", "Horse", "Corvid", "Mosquito Pool"),
        options = list(
          "actions-box" = TRUE,
          noneSelectedText = "Please select"
        ),
        multiple = TRUE
      )))

  fluidRow(
      tags$style(type = "text/css", "#map {height: calc(84vh - 80px) !important;}"),
      leafletOutput("map")
)

```

```{r, context='server', echo=FALSE, message=FALSE, warning=FALSE}

#create reactive data for map
    reactive_data_map = reactive({
      
      req(input$slider)
      
       WNV_detections%>%
        group_by(lha)%>%
        filter(between(year,input$slider[1],input$slider[2]),
               animal_type %in% (input$select_species))%>%
        count()%>%
        right_join(., lha, by = c("lha" = "LOCAL_HLTH_AREA_NAME"))%>%
        # filter(HLTH_AUTHORITY_NAME %in% (input$select_HA))%>%
      mutate(n = replace_na(n, 0))})
  
    #map
     
          output$map = renderLeaflet ({
       leaflet(lha) %>%
       addTiles() %>%
       setView(lng = -121.813212, lat = 51.813212, zoom = 6)%>%
       addLegend(
         colors = c('#E2E2E2', '#fcba97', '#D67229', '#8d4004', "#421f03"),
         values = c("0", "1-4", "5-9", "10-14", "15+"),
         labels = c("0", "1-4", "5-9", "10-14", "15+"),
         opacity = 0.8,
         title = " <center> WNv <br> Detections",
         position = "bottomleft")})

     observe({
       
       #labels to show on hover of LHA
       labels = case_when(input$slider[1] == input$slider[2] ~ sprintf(
         "<strong> %s</strong><br/> Year: %s</strong><br/>West Nile virus detections: %g",
         reactive_data_map()$lha,
         input$slider[1],
         reactive_data_map()$n),
         input$slider[1] != input$slider[2] ~ sprintf(
           "<strong> %s</strong><br/> Years: %s</strong> - %s</strong><br/>West Nile virus detections: %g",
           reactive_data_map()$lha,
           input$slider[1],
           input$slider[2],
           reactive_data_map()$n))%>%
         lapply(htmltools::HTML)

        #add polygons
       
        map = leafletProxy("map", data = reactive_data_map()) %>%
          clearShapes() %>%
          clearMarkers()
        
        req(input$select_species %in% c("Human", "Horse", "Corvid", "Mosquito Pool"))
        map %>% addPolygons(
            data = reactive_data_map()$geometry,
            fillColor = case_when(reactive_data_map()$n >= 1 & reactive_data_map()$n <=4 ~ "#fcba97",
                                          reactive_data_map()$n >= 5 & reactive_data_map()$n <=9 ~ "#D67229",
                                          reactive_data_map()$n >= 10 & reactive_data_map()$n <=14 ~ "#8d4004",
                                          reactive_data_map()$n >= 15 ~ "#421f03",
                                          reactive_data_map()$n == 0 ~ "#E2E2E2"),
                    weight = 1,
                    opacity = 0.8,
                    color = "#696868",
                    fillOpacity = case_when(reactive_data_map()$n == 0 ~ 0.7,
                                            reactive_data_map()$n > 0 ~ 0.8),
          highlightOptions = highlightOptions( #outline of FSAs on hover
            weight = 4,
            color = "#46ebeb",
            fillOpacity = 0.7,
            bringToFront = TRUE),
          label = labels)
  }
)

```
</div>

<br>
<div class="section_topic2">


![](images/Line2.png)

# Mosquito Surveillance

#### From 2003-2014, the BCCDC conducted active mosquito surveillance focused on WNV testing, identification, and distribution of adult mosquitoes to monitor local mosquito populations for WNV. At the time the program was initiated, WNV present in neighboring jurisdictions but not yet present in BC. Active mosquito surveillance was discontinued as a component of the WNV surveillance program after the 2014. Throughout the course of this program, WNV was detected in 11 mosquito pools of _Culex tarsalis_ in the South Okanagan (10 in 2009, 1 in 2013).

#### In the summer of 2024, ten years after routine mosquito surveillance was last conducted in the province, an 8-week pilot mosquito surveillance program was conducted in the Nanaimo and Osoyoos regions and captured mosquitoes were pathogen tested for Snowshoe hare and Jamestown Canyon viruses of the California serogroup in addition to WNV.  

<br>

```{r, map-table, context='render', echo=FALSE, message=FALSE, warning=FALSE}

# MOSQUITO TABLE & MAP UI 

  fluidRow(
    #titlePanel("Mosquito Surveillance"),
    column(4, selectInput("year", "Select Year", years, selected = "2003")),
    column(4, selectInput("m_specie", "Select Mosquito Species:", species)),
    column(4, selectInput("HSDA", "Select HSDA:", names(HSDA_reverse_map), selected = "All HSDA's", multiple = TRUE)))

 fluidRow(
    column(12, 
      materialSwitch("toggle_view", label = "Show Map", status = "primary", value = FALSE, inline = TRUE)
    )
  )

  
  # Conditional Panels for Table & Map
  fluidRow(
    conditionalPanel(
      condition = "input.toggle_view == false",
      column(12, dataTableOutput("summaryTable")),
      column(12, downloadButton("downloadTable", "Download Table"))
    ),
    conditionalPanel(
      condition = "input.toggle_view == true",
      column(12, leafletOutput("mosquito_map", height = 680))
    )
  )



```

```{r, context='server', echo=FALSE, message=FALSE, warning=FALSE}

# MOSQUITO TABLE & MAP SERVER

observeEvent(input$HSDA, {
    if ("All HSDA's" %in% input$HSDA && length(input$HSDA) > 1) {
      updateSelectInput(session, "HSDA", selected = "All HSDA's")
      showNotification("Cannot select 'All HSDA's' with other HSDAs. Reset to 'All HSDA's'.", type = "warning")
    }
  })

filtered_data_table <- reactive({
    mosquito_count_reports1 %>%
      filter(Year == input$year) %>%
      filter(HSDA %in% if ("All HSDA's" %in% input$HSDA) HSDA_full_names[-1] else input$HSDA)
  })
  
  
  # Reactive expression for summary computation for m_species
  summary_table <- reactive({
    data <- filtered_data_table()
    
    if (input$m_specie == "All species") {
      data %>%
        group_by(HSDA) %>%
        summarize(
          Aedes = round(sum(Aedes, na.rm = TRUE), 0),
          Anopheles = round(sum(Anopheles, na.rm = TRUE),  0),
          Coquillettidia = round(sum(Coquillettidia, na.rm = TRUE),  0),
          `Culex pipiens` = round(sum(`Culex pipiens`, na.rm = TRUE),  0),
          `Culex tarsalis` = round(sum(`Culex tarsalis`, na.rm = TRUE),  0),
          `Culex territans` = round(sum(`Culex territans`, na.rm = TRUE),  0),
          Culiseta = round(sum(Culiseta, na.rm = TRUE),  0),
          Total = round(sum(Aedes, Anopheles, Coquillettidia, `Culex pipiens`, 
                      `Culex tarsalis`, `Culex territans`, Culiseta, na.rm = TRUE),  0),
          .groups = "drop"
        )
    } else {
      data %>%
        group_by(HSDA) %>%
        summarize(
          `Total Cases` = round(sum(.data[[input$m_specie]], na.rm = TRUE),  0),
          .groups = "drop"
        )
    }
  })
  
  # Render the summary table (Output 1)
  output$summaryTable <- renderDataTable({
    summary_table() %>%
      mutate(
        HSDA = ifelse(HSDA %in% HSDA_full_names, HSDA, "Unknown HSDA"),
        across(where(is.numeric), as.integer)  # Ensure numeric columns are integers
      ) %>%
      datatable(
        options = list(
          paging = FALSE,          # Show all rows (No pagination)
          searching = FALSE,       # Hide search bar
          ordering = FALSE,        # Disable sorting
          scrollY = FALSE,         # No vertical scrolling
          autoWidth = TRUE,        # Adjust column width
          dom = 't',               # Remove table UI elements except table itself
          class = 'compact',       # Apply compact styling
         columnDefs = list(
            list(className = 'dt-left', targets = 0),  # Left-align first column (HSDA)
            list(className = 'dt-center', targets = "_all")  # Center rest of columns
          )
        ),
        rownames = FALSE
      ) %>%
      
      formatStyle(
        columns = colnames(summary_table()),  # Apply styles to all columns
        #fontWeight = 'bold'
      ) %>%
      
      formatStyle(
        "HSDA",  # Specifically target HSDA column
        textAlign = 'left'
      ) 
  })
  
output$downloadTable <- downloadHandler(
  filename = function() {
    paste("Mosquito_Surveillance_", input$year, ".xlsx", sep = "")
  },
  content = function(file) {
    write_xlsx(summary_table(), file)  # Ensure it references summary_table()
  }
)
  
  #map server code - reactive expression for filtered data (year, HSDA)
  filtered_data_map <- reactive({
    merged_data <- HSDA_layer %>%
      dplyr::left_join(mosquito_count_reports1, 
                       by = c("HLTH_SERVICE_DLVR_AREA_NAME" = "HSDA")) %>%
      filter(Year == input$year)%>%
      filter(HLTH_SERVICE_DLVR_AREA_NAME %in% 
               if ("All HSDA's" %in% input$HSDA) HSDA_full_names 
             else input$HSDA) %>%
      group_by(HLTH_SERVICE_DLVR_AREA_NAME, Year) %>%
      ungroup() %>%
      select(HLTH_SERVICE_DLVR_AREA_NAME, Year, geometry, Aedes, Anopheles, Coquillettidia, 
             `Culex pipiens`,	`Culex tarsalis`,	`Culex territans`, Culiseta, Total) %>%
      rename(HSDA = HLTH_SERVICE_DLVR_AREA_NAME)
    
    # Check if dataset is empty
    if (nrow(merged_data) == 0) {
      showNotification("No data available for the selected filters.", type = "warning")
      return(NULL)
    }
    
    # Convert to sf object
    st_as_sf(merged_data)
  })
  
  
  # Reactive expression for summary computation for m_species
  map_summary <- reactive({
    data1 <- filtered_data_map()
    
    if (is.null(data1) || nrow(data1) == 0) {
      return(NULL)  # Prevent further processing on NULL values
    }
    
    if (input$m_specie == "All species") {
      data1 %>%
        group_by(HSDA,Year) %>%
        summarize(
          Aedes = round(sum(Aedes, na.rm = TRUE),  0),
          Anopheles = round(sum(Anopheles, na.rm = TRUE),  0),
          Coquillettidia = round(sum(Coquillettidia, na.rm = TRUE),  0),
          `Culex pipiens` = round(sum(`Culex pipiens`, na.rm = TRUE),  0),
          `Culex tarsalis` = round(sum(`Culex tarsalis`, na.rm = TRUE),  0),
          `Culex territans` = round(sum(`Culex territans`, na.rm = TRUE),  0),
          Culiseta = round(sum(Culiseta, na.rm = TRUE),  0),
          Total = round(sum(Aedes, Anopheles, Coquillettidia, `Culex pipiens`, 
                            `Culex tarsalis`, `Culex territans`, Culiseta, na.rm = TRUE),  0),
          .groups = "drop"
        )
    } else {
      data1 %>%
        group_by(HSDA, Year) %>%
        summarize(
          `Total Cases` = round(sum(.data[[input$m_specie]], na.rm = TRUE),  0),
          .groups = "drop"
        )
    }
  })
  
  # Render the interactive map using leaflet (OUtput 2)
  
output$mosquito_map <- renderLeaflet({
  req(map_summary())  

  species_col <- if (input$m_specie == "All species") "Total" else input$m_specie

  data <- filtered_data_map()

  # Check if data is available
  if (is.null(data) || nrow(data) == 0) {
    showNotification("No data available for the selected filters.", type = "warning")

    return(leaflet() %>%
             addTiles() %>%
             setView(lng = -122.649791, lat = 52.813212, zoom = 6))
  }

  # Check if the species column exists
  if (!(species_col %in% colnames(data))) {
    showNotification("Selected species data is unavailable.", type = "error")
    return(NULL)
  }

  # Check if the selection results in all NA values
  if (all(is.na(data[[species_col]]))) {
    showNotification(paste0("Error: ", input$m_specie, " wasn't searched for in this year."), type = "error")
    return(leaflet() %>% 
            addTiles() %>% 
            setView(lng = -122.649791, lat = 52.813212, zoom = 6) %>%
            addPolygons(
      data = HSDA_layer,  # Use the base shapefile
      fillColor = "#D3D3D3",  # Light gray for unselected HSDAs
      weight = 1,
      opacity = 0.8,
      color = "#696868",
      fillOpacity = 0.75,  # Semi-transparent gray
      label = NULL
    ))
  }
  
# Get unique values in selected data
  unique_values <- unique(data[[species_col]][!is.na(data[[species_col]])])

  # Determine color binning strategy
  if (length(unique_values) == 1) {
    # If only one unique value, use colorFactor instead of colorBin
    pal <- colorFactor(palette = c("#D3D3D3", "#FFEDA0"), domain = unique_values)
  } else {
    # Normal binning logic for multiple values
    min_value <- min(data[[species_col]], na.rm = TRUE)
    max_value <- max(data[[species_col]], na.rm = TRUE)
    bins <- pretty(c(min_value, max_value), n = 5)
    pal <- colorBin(palette = "YlOrRd", domain = data[[species_col]], bins = bins, na.color = "#D3D3D3")
  }

  # Defining the hover label
  data$tooltip <- paste0(
    "<b>", data$HSDA, "</b><br>",
    "Year: ", input$year, "<br>",
    "Species: ", input$m_specie, "<br>",
    "Cases: ", format(data[[species_col]], big.mark = ",")
  )

  # Create Leaflet map
  leaflet(data) %>%
    addTiles() %>%
    setView(lng = -122.649791, lat = 52.813212, zoom = 6) %>%

    addPolygons(
      data = HSDA_layer,  # Use the base shapefile
      fillColor = "#D3D3D3",  # Light gray for unselected HSDAs
      weight = 1,
      opacity = 0.8,
      color = "#696868",
      fillOpacity = 0.75,  # Semi-transparent gray
      label = NULL
    )  %>%

    addPolygons(
      fillColor = ~pal(get(species_col)),  
      weight = 1,
      opacity = 1,
      color = "#696868",
      fillOpacity = 0.7,
      highlightOptions = highlightOptions(
        weight = 4,
        color = "#46ebeb",
        bringToFront = TRUE
      ),
      label = ~lapply(tooltip, htmltools::HTML), 
      labelOptions = labelOptions(
        style = list("font-weight" = "normal", "font-size" = "12px"),
        textsize = "12px",
        direction = "auto"
      )
    ) %>%
    addLegend(
      pal = pal,
      values = data[[species_col]],
      title = paste("Mosquito Count:", input$m_specie, input$year),
      position = "bottomleft",
      opacity = 0.8,
      labFormat = labelFormat(
        big.mark = ",", 
        digits = 0,     
        transform = function(x) round(x)
      )
    )
})




```


## {.tabset}


### _Aedes spp._

<div class="sub_bullet">
```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
for (line in aedes) {
  cat(line, '\n')
}
```
</div>

<br>

### _Anopheles spp._

<div class="sub_bullet">
```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
for (line in anopheles) {
  cat(line, '\n')
}
```
</div>

<br>


### _Culex spp._

<div class="sub_bullet">
```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
for (line in culex) {
  cat(line, '\n')
}
```
</div>

<br>

### _Culiseta spp._

<div class="sub_bullet">
```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
for (line in culiseta) {
  cat(line, '\n')
}
```
</div>

<br>


### _Coquillettidia spp._
<div class="sub_bullet">
```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
for (line in coquilletidia) {
  cat(line, '\n')
}
```

</div>

<br>

## {-}

![](images/Line2.png)


<div class="section_topic3">
# Supplementary information {.tabset}


## Data notes

<div class="sub_bullet">
```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
for (line in data_notes_outbreak) {
  cat(line, '\n')
}
```
</div>

<br>


## Data Sources

<div class="sub_bullet">
```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
for (line in definitions_outbreak) {
  cat(line, '\n')
}
```
</div>
<br>

## Abbreviations

```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
for (line in abbreviations_outbreak) {
  cat(line, '\n')
}
```
<br>

## Acknowledgements

```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
for (line in acknowledgements_outbreak) {
  cat(line, '\n')
}
```
<br>

## Disclaimer

```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
for (line in disclaimer_outbreak) {
  cat(line, '\n')
}
```
</div>
<br>

